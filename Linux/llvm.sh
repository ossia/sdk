#!/bin/bash

source ./common.sh

(
mkdir -p llvm-build-16
cd llvm-build-16
$CMAKE  -GNinja \
 -DCMAKE_BUILD_TYPE=Release \
 -DBUILD_SHARED_LIBS=0 \
 -DLLVM_INSTALL_TOOLCHAIN_ONLY=ON \
 -DLLVM_TARGETS_TO_BUILD="X86" \
 -DLLVM_INCLUDE_EXAMPLES=0 \
 -DLLVM_INCLUDE_TESTS=0 \
 -DLLVM_CXX_STD="c++20" \
 -DCLANG_DEFAULT_CXX_STDLIB:STRING=libc++ \
 -DCLANG_DEFAULT_RTLIB:STRING=libgcc \
 -DLIBCXX_ABI_UNSTABLE=ON \
 -DLIBCXX_USE_COMPILER_RT=OFF \
 -DLIBCXXABI_USE_COMPILER_RT=OFF \
 -DLIBUNWIND_USE_COMPILER_RT=OFF \
 -DLLVM_ENABLE_PROJECTS="clang;lld;polly" \
 -DLLVM_ENABLE_RUNTIMES="libcxx;libcxxabi;libunwind" \
 -DLLVM_ENABLE_OCAMLDOC=OFF \
 -DLLVM_ENABLE_BINDINGS=0 \
 -DLLVM_INCLUDE_BENCHMARKS=0 \
 -DCMAKE_INSTALL_PREFIX=$SDK_ROOT/llvm-bootstrap \
 $LLVM_ADDITIONAL_FLAGS \
 ../llvm/llvm

$CMAKE --build .
$CMAKE --build . --target install/strip
)

# LLVM is bootstrapped so that it is all built with the same libc++ version
(
mkdir -p llvm-build
cd llvm-build
export PATH=$SDK_ROOT/llvm-bootstrap/bin:$PATH
export LD_LIBRARY_PATH=$SDK_ROOT/llvm-bootstrap/lib:$SDK_ROOT/llvm-bootstrap/lib/x86_64-unknown-linux-gnu:$LD_LIBRARY_PATH

echo $LD_LIBRARY_PATH
$CMAKE -GNinja \
 -DCMAKE_C_COMPILER=$SDK_ROOT/llvm-bootstrap/bin/clang \
 -DCMAKE_CXX_COMPILER=$SDK_ROOT/llvm-bootstrap/bin/clang++ \
 -DCMAKE_C_FLAGS="$CFLAGS" \
 -DCMAKE_CXX_FLAGS="$CXXFLAGS" \
 -DCMAKE_BUILD_TYPE=Release \
 -DBUILD_SHARED_LIBS=0 \
 -DLLVM_INCLUDE_TOOLS=1 \
 -DLLVM_BUILD_TOOLS=1 \
 -DLLVM_INCLUDE_EXAMPLES=0 \
 -DLLVM_INCLUDE_TESTS=0 \
 -DLLVM_CXX_STD="c++20" \
 -DLLVM_TARGETS_TO_BUILD="X86" \
 -DLLVM_ENABLE_OCAMLDOC=OFF \
 -DLLVM_ENABLE_BINDINGS=0 \
 -DLLVM_INCLUDE_BENCHMARKS=0 \
 -DLLVM_ENABLE_CURSES=0 \
 -DLLVM_ENABLE_TERMINFO=0 \
 -DLLVM_ENABLE_LIBCXX=ON \
 -DLLVM_ENABLE_LLD=ON \
 -DLLVM_ENABLE_EH=ON \
 -DLLVM_ENABLE_RTTI=ON \
 -DLLVM_ENABLE_PROJECTS="clang;lld;polly" \
 -DLLVM_ENABLE_RUNTIMES="libcxx;libcxxabi" \
 -DCLANG_DEFAULT_CXX_STDLIB:STRING=libc++ \
 -DCLANG_DEFAULT_RTLIB:STRING=libgcc \
 -DLIBCXX_ABI_UNSTABLE=ON \
 -DLIBCXX_USE_COMPILER_RT=OFF \
 -DLIBCXX_ENABLE_STATIC_ABI_LIBRARY=OFF \
 -DLIBCXXABI_USE_LLVM_UNWINDER=OFF \
 -DLIBCXXABI_ENABLE_STATIC_UNWINDER=OFF \
 -DLIBCXXABI_USE_COMPILER_RT=OFF \
 -DLIBUNWIND_USE_COMPILER_RT=OFF \
 -DCOMPILER_RT_USE_BUILTINS_LIBRARY=OFF \
 -DCMAKE_INSTALL_PREFIX=$INSTALL_PREFIX/llvm \
 $LLVM_ADDITIONAL_FLAGS \
 ../llvm/llvm

$CMAKE --build . --parallel
$CMAKE --build . --target install/strip
)

(
  cd $INSTALL_PREFIX/llvm
  ln -s lib lib64
)
